pipeline {
    environment {
        webappImageName = "marlapativ/webapp-cve-processor"
        dbMigrationImageName = "marlapativ/db-migration"
        registryCredential = 'dockerhub'
    }
    agent any
    stages {
        stage('Setup Docker') {
            steps {
                sh '''
                    if [ -n "$(docker buildx ls | grep multiarch)" ]; then
                        docker buildx use multiarch
                    else
                        docker buildx create --name=multiarch --driver=docker-container --use --bootstrap 
                    fi
                '''
                
                script {
                    withCredentials([usernamePassword(credentialsId: registryCredential, passwordVariable: 'password', usernameVariable: 'username')]) {
                        sh('docker login -u $username -p $password')
                    }
                }
            }
        }
        stage('Generate Version') {
            tools {
                nodejs "nodejs"
            }
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'GITHUB_TOKEN', usernameVariable: 'GITHUB_USERNAME')]) {
                        sh '''
                            npx semantic-release \
                                -p @semantic-release/commit-analyzer \
                                -p @semantic-release/release-notes-generator \
                                -p @semantic-release/github
                        '''
                    }
                }
            }
        }
        stage('Build and Push Docker Images') {
            parallel {
                stage('Build and Push Webapp Docker Image') {
                    steps {
                        sh '''
                            export IMAGE_TAG=$(git describe --tags --abbrev=0)

                            docker buildx build \
                            --platform linux/amd64,linux/arm64 \
                            --builder multiarch \
                            -t $webappImageName:latest \
                            -t $webappImageName:$IMAGE_TAG \
                            --push \
                            .
                        '''
                    }
                }
                
                stage('Build and Push FlyWay Docker Image') {
                    steps {
                        sh '''
                            export IMAGE_TAG=$(git describe --tags --abbrev=0)

                            docker buildx build \
                            --platform linux/amd64,linux/arm64 \
                            --builder multiarch \
                            -t $dbMigrationImageName:latest \
                            -t $dbMigrationImageName:$IMAGE_TAG \
                            --push \
                            flyway/
                        '''
                    }
                }
            }
        }
    }
}
