package main

import (
	processor "github.com/csye7125-su24-team06/webapp-cve-processor/internal"
	"github.com/csye7125-su24-team06/webapp-cve-processor/internal/env"
	"github.com/sirupsen/logrus"
)

type UTCFormatter struct {
	logrus.Formatter
}

func (u UTCFormatter) Format(e *logrus.Entry) ([]byte, error) {
	e.Time = e.Time.UTC()
	return u.Formatter.Format(e)
}

func main() {
	logrus.SetFormatter(UTCFormatter{&logrus.JSONFormatter{}})

	url := env.GetEnvOrDefault("CVE_LIST_URL", "https://github.com/CVEProject/cvelistV5/archive/refs/heads/main.zip")

	// Setting up Kafka client - Producer
	logrus.Println("Setting up Kafka client...")
	kafkaClient := processor.NewKafkaProducer()
	defer kafkaClient.Close()

	// Initialize the topic
	logrus.Println("Initializing Kafka topic...")
	kafkaClient.InitTopic()

	// Process the zip
	logrus.Println("Processing...")
	processor.Process(url, &kafkaClient)

	logrus.Println("Done...")
}
