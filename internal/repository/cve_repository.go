package repository

import (
	"github.com/csye7125-su24-team06/webapp-cve-processor/internal/models"
	"github.com/csye7125-su24-team06/webapp-cve-processor/pkg/database"

	"gorm.io/gorm"
	"gorm.io/gorm/clause"
)

func InsertCve(cveDoc *models.Cve) {
	database.DataSource.Create(&cveDoc)
}

func BulkInsertCve(cveDocs []models.Cve) {
	database.DataSource.Clauses(clause.OnConflict{DoNothing: true}).Create(cveDocs)
}

func FetchLatestBySHA1(sha1 string) (models.Cve, *gorm.DB) {
	var cveDoc models.Cve
	gormTx := database.DataSource.Select("cve_id").Where("sha1 = ?", sha1).Order("created_at DESC").First(&cveDoc)
	return cveDoc, gormTx
}

func FindCves(cveId string) (models.Cve, *gorm.DB) {
	var cveDoc models.Cve
	gormTx := database.DataSource.Where("cve_id = ?", cveId).Order("date_updated DESC").Limit(1).First(&cveDoc)
	return cveDoc, gormTx
}
